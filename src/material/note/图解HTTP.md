# 图解HTTP

### 第一章 了解WEB及网络基础

#### 一. HTTP的诞生

​	HTTP(Hypertext Transfer Protocol) 超文本传输协议。其是一种无状态协议。

+ HTTP/0.9 1990
+ HTTP/1.0 1996.5
+ HTTP/1.1 1997.1 当前主流HTTP协议版本
+ [HTTP/2.0](HTTP/2.0) 2013

#### 二. 网络基础TCP/IP

1. TCP/IP是互联网相关的各类协议族的总称。包扩但不限于`IP DNS TCP FTP HTTP PPPoE UDP SNMP ICMP`
2. TCP/IP的分层管理，由上至下 可简化为`应用层 传输层 网络层 数据链路层`。
   + 应用层, 决定了向用户提供应用服务时通信的活动， `FTP DNS HTTP`都属于该层。
   + 传输层，传输层对上层应用层提供处于网络连接中的两台计算机 之间的数据传输，`TCP（传输控制协议`）和`UDP（用户数据协议）`都属于该层。
   + 网络层，用来处理网络上流动的数据包。规定通过怎样的路径到达对方的计算机，并把数据包传送给对方。`IP`属于该层。
   + 数据链路层，用来处理网络的硬件部分。包括控制操作系统、硬件的设备驱动、NIC(网卡)等物理可见部分。
3. 通信传输流和数据的封装：发送端发起HTTP请求后，数据从应用层开始依次通过各个层次，应用层的HTTP报文数据依次被添加TCP首部、IP首部、以太网首部后通过链路层到达接收端。接收端自下而上层层传输，每经一层去掉对应首部。
4. IP、TCP、DNS
   + IP协议，主要包含**IP编址方案、分组封装格式及分组转发规则**三方面内容,负责把各种数据包传送给对方`对上可载送传输层各种协议的信息，例如TCP、UDP等；对下可将IP信息包放到链路层，通过以太网、令牌环网络等各种技术来传送。`
   + TCP协议，提供[可靠的](https://www.jianshu.com/p/42dbcd39c3e7)（确保传输，三次握手，超时重传， 拥塞控制）字节流服务（将大数据块分割成以报文段为单位的数据包进行管理）。
   + DNS协议，提供域名到IP地址之间的解析服务。
5. HTTP请求主流程
   1. 客户端通过DNS获取域名对于IP地址
   2. HTTP协议生成针对目标服务器的HTTP请求报文
   3. TCP协议将HTTP请求报文分割成报文段，确保传输到服务器
   4. IP协议搜索对方地址，一边中转一边传输
   5. HTTP协议对请求的内容进行处理
   6. 通过TCP/IP协议回传

#### 三. URL 和URI

​	URL（统一资源定位符）是URI（统一资源标识符）的子集。

### 第二章 简单的HTTP协议

#### 一.请求和响应报文报文的构成

1. 请求报文

   ```
   POST /image HTTP1.1  				// 方法 URL 协议版本 -> 请求行
   HOST: yomij.cn                      // 请求首部字段
   Connection: keep-alive
   content-Type: application/ json
   
   name=yomi&sex=man                   // 内容实体
   ```
   
2. 响应报文

   ```
   HTTP/1.1 200 OK                     // 协议版本 状态码 状态码的原因短语 -> 状态行
   Date: Tue, 10 Jul 2020 06:50:15 GMT // 响应首部字段                  -> 首部字段
   content-Type: application/ json
   
   { name : yomi }                     // 响应主体
   ```

#### 二. HTTP方法

1. GET:  获取资源。请求已被URI识别的资源，指定的资源经服务器端解析后返回响应内容。
2. POST:  传输实体主体。功能与GET很相似，但主要目的不是获取响应的主题内容。
3. PUT:  传输文件。自身不带验证机制，存在安全性问题。
4. HEAD:  获得报文首部。与GET方法一样，但不返回报文的主体部分。用以确认资源的有效性和更新日期等。
5. DELETE: 删除文件。
6. OPTIONS: 查询针对请求URI指定的资源支持的方法。
7. TRACE: 让服务器端将之前的请求通信返回给客户端的方法。通过Max-Forwards首部中插入数值，没经一个服务端就减1，为0时停止传输，最后请求的服务器返回状态码为200的响应。
8. CONNECT: 要求在与代理服务器通信时建立隧道，实现用隧道进行TCP协议。主要使用SSL协议和TLS协议把通信内容加密后经网络隧道传输。

#### 三. 持久连接

1. 为减少无谓的TCP连接断开增加通信量的开销，HTTP协议被设计为持久连接的，即保持TCP连接状态。在HTTP/1.1中，所有连接默认都是持久连接。
2. 持久连接使管线化（pipelining）成为可能。可以并行发送多个请求，提高响应速度。

#### 四. cookie状态管理

​	由于HTPP是无状态协议，这可以减少服务器CPU和内存资源消耗，但也无法根据之前的状态进行本次状态的管理。Cookie技术在请求和响应报文写于Cookie信息控制客户端状态。

​	Cookie技术会根据服务端Set-Cookie的首部字段通知客户端保存cookie，当下次客户端发送请求时会自动在请求报文中加入cookie值。服务器会根据cookie判断是从哪个客户端发来的请求，并于服务器记录对比，等到之前的状态信息。

### 第三章 HTTP报文内的HTTP信息

#### 一.HTTP报文

1. 用于HTTP协议交互的信息被称为HTTP报文(8位组字节流)。报文本身是由多行（CR+LF作换行符）数据构成的字符串文本

2. 报文大致可以分为报文首部和报文主体两块，由最初出现的换行符划分。

3. 首部可分为 通用首部 请求首部 响应首部 实体首部 四个首部。

#### 二.编码提升传输效率

1. 由服务器进行内容编码，客户端进行解码。常见有gzip compress(UNIX 标准压缩) deflate(zlib) identity(不进行编码)四种
2. 分块传输编码：实体主体过大时，对其进行分块。每一块都有十六进制来标记块的大小，最后一块使用“0(CR+LF)”标记

#### 三.多部分对象集合

多部分对象集合，用来容纳多份不同类型的数据。包含：

+ multipart/form-data 表单上传 request使用
+ multipart/byteranges 状态码206(partial content) 响应报文包含多个范围的内容时使用。response使用

#### 四.获取部分内容的范围请求

+ 通过Range字段请求部分数据，服务器支持，则返回206(partial content) ，反之返回200 OK和全部数据。

  ```
  // 5000-10000字节
  Range: bytes=5000-10000
  // 5000字节之后的全部
  Range: bytes= 5000-
  // 多重返回
  Range: bytes=0-1000,5000-6000
  ```

#### 五. 内容协商

服务器和客户端就以语言、字符集、编码方式等为基准对响应内容进行交涉。相关字段有:

+ Accept
+ Acctpe-Charset
+ Accept-Encoding
+ Accept-Language
+ Content-Language

协商类型有：

+ 服务器驱动协商：以请求首部字段为参考，在服务器端自动处理
+ 客户端驱动协商：用户从浏览器显示的可选列表中手动选择，或用js自动进行上述选择。
+ 透明协商：结合体，由服务器和客户端各自进行内容协商。

### 第四章 返回结果的HTTP状态码

#### 一. 状态码类别

+ 1XX 信息性状态码 接收的请求正在处理
+ 2XX 成功性状态码 请求正常处理完毕
+ 3XX 重定向状态码 需要符加操作以卧槽请求
+ 4XX 客户端错误状态码 服务器无法处理请求
+ 5XX 服务器错误状态码 服务器处理请求出错

#### 二. 常见状态码

1. 2XX 成功处理
   + 200 OK
   + 204 No Content 返回响应报文不含实体的主体部分
   + 206 Partial Content 客户端进行了部分请求 ，返回了由Content-Range指定返回的实体内容
2. 3XX 重定向
   + 301 Moved Permanently 永久性重定向
   + 302 Found 临时性重定向
   + 303 See Other 请求对应资源存在另一个URI 应使用GET 方法定向获取请求的资源
   + 304 Not Modifined 服务器资源未变更，可使用客户端未过期的缓存
   + 307 Temporary Redirect 与302有相同含义，但不回从POST边为GET请求新资源
3. 4XX 客户端错误
   + 400 Bad Request 请求报文中存在语法错误
   + 401 Unauthorized 未认证
   + 403 Forbidden 访问被拒绝（无权限等）
   + 404 Not Found 资源不存在
4. 5XX 服务器错误
   + 500 Internal Server Error 服务器端执行请求时发生了错误
   + 503 Service Unavailable 服务器处于超负载或正在停机维护

### 第五章 与HTTP协助的Web服务器

可以使用单台虚拟主机搭建多个web站点，Host首部用以指定主机或域名的URI

####  一. 代理

一种有转发功能的应用程序。接收客户端发送的请求后转发给其他服务器。代理不改变请求的URI。转发时需要附加Via首部字段以标记经过的主机信息。

1. 缓存代理：预先将资源的副本保存在代理服务器上。
2. 透明代理：转发请求或响应时，不对报文做任何价格的代理类型。反正为非透明代理。

#### 二.网关

转发其他服务器通信数据的服务器，像拥有资源的源服务器一样有对请求进行处理。

能提高通信的安全性。

功能与代理相似，但能提供非HTTP协议的服务，如SQL查询。

#### 二.隧道

按要求建立一条与其他服务器的通信线路，使用SSL等加密手段进行通信。目的时确保客户端能够与服务器进行安全的通信。

### 第六章 HTTP首部

#### 一.首部类型

+ 通用首部字段：请求和响应报文都会使用的字段。

  | 字段名           | 说明                                                         |
  | ---------------- | ------------------------------------------------------------ |
  | Connection       | 控制不再转发给代理的首部字段 持久连接（keep-alive）的管理    |
  | Date             | 创建报文时间                                                 |
  | Warning          | 错误通知                                                     |
  | Cache-Control    | no-cache 强制服务器再次验证<br/>no-store 不缓存（暗示包含机密信息）<br/>max-age=[秒] s-maxage=[秒] 响应最大age值 s-maxage用以公共信息<br/>max-stale 接收已过期响应<br/>min-fresh=[秒] 期望在指定时间内响应有效<br/>no-transfrom 代理不可更改媒体类型<br/>onle-if-cache 从缓存中获取资源<br/>public private 缓存使用范围 |
  | Transer-Encoding | 指定报文主体编码方式（仅对分块传输有效）                     |
  | Via              | 代理服务器相关信息，追踪代理转发路径                         |
  | Upgrade          | 检测是否可以用更高版本协议进行通信                           |
  | 。。。           | 。。。                                                       |

+ 请求首部字段：客户端向服务器发送请求报文时使用。

  | 字段名                                                       | 说明                                                         |
  | ------------------------------------------------------------ | ------------------------------------------------------------ |
  | Accept                                                       | 告知用户代理能处理的媒体类型和相对优先级，如:text/html，image/jpeg。 |
  | Accept-Charset<br/>Accept-Encoding<br/>Accept-Language       | 告知用户代理支持的字符集<br/>告知支持的内容编码和编码类型 如：gzip,compress,deflate<br/>告知支持的语言，如 zh-cn,zh,en-us |
  | Authorization                                                | 告知用户代理的认证信息。                                     |
  | From                                                         | 告知用户代理的用户的电子邮件地址。                           |
  | Host                                                         | 请求资源所在的主机名和端口号。                               |
  | If-Match<br/>If-Modified-Since<br/>If-None-Match<br/>If-Range<br/>If-Unmodified-Since | 条件请求。通过Etag 改动时间范围 匹配，成功后才执行请求。     |
  | Max-Frowards                                                 | 最大转发数，每经过一次转发-1，用以记录转发路径。为0时不再转发 直接返回。 |
  | Ranage                                                       | 请求资源部分范围，无法处理则返回200和全部资源。反之返回206状态码。 |
  | Referer                                                      | 原始资源的URI。                                              |
  | User-Agent                                                   | 传递用户代理名称等信息。                                     |

+ 响应首部字段

  | 字段名           | 说明                                                         |
  | ---------------- | ------------------------------------------------------------ |
  | Accept-Ranages   | 告知客户端能否处理部分请求 值为bytes或none。                 |
  | Age              | 告知客户端源服务器在多久前创建了请求单位为秒。               |
  | ETag             | 实体标识，资源更新时分配新值。没有统一算法规则，由服务器分配。 |
  | Location         | 将响应接收方引导至与请求URI位置不同的资源。                  |
  | Retry-After      | 告知服务器多久后或未来某个时间再来访问。                     |
  | Server           | 告知当前服务器上安装的Http服务器应用程序的消息               |
  | Vary             | 缓存控制。仅对请求中含有包含Vary指定请求首部的请求返回       |
  | WWW-Authenticate | 告知指定资源的认证方案                                       |

+ 实体首部字段：针对请求报文和响应报文实体部分使用。

  | 字段名            | 说明                                                         |
  | ----------------- | ------------------------------------------------------------ |
  | Allow             | 告知客户端，资源允许的所有方法                               |
  | Content-Encording | 实体的主体部分的内容编码方式 主要以下四种: gizp compress deflate identity |
  | Content-Language  | 告知实体主体使用的自然语言                                   |
  | Content-Length    | 单位字节。实体主体部分的大小。                               |
  | Content-Location  | 主体返回资源对应的URI                                        |
  | Content-MD5       | 用以判断报文主体传输过程是否完整                             |
  | Content-Range     | 资源返回                                                     |
  | Content-Type      | 实体主体的媒体类型                                           |
  | Expires           | 告知资源的失效日期                                           |
  | Last-Modified     | 资源的最后修改时间                                           |

  

#### 二. Cookie

1. Set-Cookie

   ```
   Set-Cookie: NAME=VALUE,expire=DATE,path=PATH,domain=域名,Secure, HttpOnly
   ```

   Secure 字段显示https才能使用cookie

   HttpOnly字段阻止js获取cookie

### 第五章 确保安全的HTTPS

+ http具有显著缺点：
  1. **使用明文，内容可能被监听**
  2. **不验证通信方身份，可能遭遇伪装**
  3. **无法证明报文完整性，可能遭受篡改**

+ 通过SSL(安全套接层)或TSL(安全传输层协议)建立安全通信后，进行http通信，这种与ssl组合使用的http被称为https。ssl不仅提供加密处理，而且使用了一种名叫证书的手段，用以确定通信方防止伪装。ssl提供认证和加密处理及摘要功能。
  1. ``HTTPS = HTTP + 加密 + 认证 + 完整性保护``
  2. https采用混合加密机制（共享密钥加密和公开密钥加密）

+ https的安全通信机制
  1. 客户端发送client hello报文开始ssl通信
  2. 服务器可进行ssl通信时，一server hello报文应答
  3. 服务器发送certificatte报文，包含公开密钥
  4. 服务器发送server hello done报文通知客户端
  5. ssl第一次握手结束，客户端一client key exchange报文作为回应，通过步骤3中的公开密钥加密
  6. 客户端发送change cipher spec报文，提示服务器，之后的报文会通过pre-master secret加密
  7. 客户端发送finished报文，包含连接至今全报文的整体校验值，握手协商是否成功，由服务器能否正确解密该报文为评判
  8. 服务器同样发送change cipher spec报文
  9. 服务器同样发送finished报文
  10. 服务器和客户端的finished报文交换完毕后，ssl算建立完成
  11. 应用层协议通信，即发送http响应
  12. 客户端断开连接，打赏close_notify报文